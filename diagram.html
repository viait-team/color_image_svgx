<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Call Sequence Diagram</title>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 2em;
        }
    </style>
</head>
<body>
    <div class="mermaid">
        graph TD
            style missing fill:#ffcccc,stroke:#ff0000,stroke-width:2px

            A(Start) --> B[main];
            B --> C[get_args];
            C --> D[color_trace_multi];

            subgraph Main Thread
                direction LR
                D -- "1. Starts N workers" --> W(Parallel Workers);
                D -- "2. Adds file jobs" --> Q1(Job Queue 1<br/>Pre-processing);
            end

            subgraph Parallel Workers
                direction TB
                W1(Worker 1) -- "3. Pulls job" --> Q1;
                W2(Worker 2) -- "3. Pulls job" --> Q1;
                WN(...) -- "3. Pulls job" --> Q1;

                Q1 -- "Job data" --> J1[q1_job];
                
                subgraph q1_job [4. Pre-process]
                    direction LR
                    J1 --> R(Rescale-Image);
                    R --> Q(Quantize-Image);
                    Q --> P(Get-PaletteFromImage);
                end

                P -- "5. Adds color jobs" --> Q2(Job Queue 2<br/>Tracing);

                W1 -- "6. Pulls job" --> Q2;
                W2 -- "6. Pulls job" --> Q2;
                WN -- "6. Pulls job" --> Q2;

                Q2 -- "Job data" --> J2[q2_job];

                subgraph q2_job [7. Trace]
                    direction LR
                    J2 --> I(Isolate-Color);
                    I --> T(trace);
                end
                
                T -- "8. After last layer" --> S[SVG Stacking];
            end

            S --> Z(End);

            class B,C,D,W,W1,W2,WN,J1,J2,S missing;
    </div>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true });
    </script>
</body>
</html>